<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signals.json Updater</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segura UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 10px;
        }

        .current-signals {
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .current-signals.loading {
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .current-signals.loaded {
            border-color: #4caf50;
            background: #f8fafc;
        }

        .current-signals.error {
            border-color: #f44336;
            background: #ffebee;
        }

        .current-signals.updated {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .current-signals-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .current-signals-icon {
            font-size: 2rem;
        }

        .current-signals-icon.loading {
            color: #2196f3;
            animation: spin 1s linear infinite;
        }

        .current-signals-icon.loaded {
            color: #4caf50;
        }

        .current-signals-icon.error {
            color: #f44336;
        }

        .current-signals-icon.updated {
            color: #ff9800;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .current-signals-info {
            flex: 1;
        }

        .current-signals-title {
            font-weight: 600;
            color: #2a5298;
            font-size: 1.1rem;
        }

        .current-signals-meta {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .file-upload {
            border: 2px dashed #2a5298;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-upload:hover, .file-upload.dragover {
            border-color: #1e3c72;
            background: #e3f2fd;
        }

        .file-upload.loaded {
            border-color: #4caf50;
            background: #e8f5e8;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: #2a5298;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #888;
        }

        .btn {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(42, 82, 152, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 82, 152, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        .status-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }

        .status-warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }

        .preview {
            background: #f8fafc;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .diff {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .diff-add {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }

        .diff-change {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .actions {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .actions h2 {
            color: #2a5298;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .file-system-note {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Signals.json Updater</h1>
            <p>Update your signal detection framework with new configurations</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üìÑ Current Signals.json</h2>
                <div class="current-signals loading" id="currentSignalsBox">
                    <div class="current-signals-header">
                        <div class="current-signals-icon loading" id="currentIcon">‚è≥</div>
                        <div class="current-signals-info">
                            <div class="current-signals-title" id="currentTitle">Loading signals.json...</div>
                            <div class="current-signals-meta" id="currentMeta">Checking local file</div>
                        </div>
                    </div>
                </div>
                <div id="currentStatus">
                    <div class="status status-info">Loading signals.json from local folder...</div>
                </div>
            </div>

            <div class="card">
                <h2>üîÑ Update.json</h2>
                <div class="file-upload" id="updateUpload">
                    <div class="upload-icon">üì•</div>
                    <div class="upload-text">Drop your update.json here</div>
                    <div class="upload-hint">or click to browse</div>
                    <input type="file" id="updateFile" accept=".json">
                </div>
                <div id="updateStatus"></div>
            </div>
        </div>

        <div class="card">
            <h2>üëÄ Preview Changes</h2>
            <div id="previewContent">
                <div class="status status-info">
                    Load an update.json file to see a preview of changes
                </div>
            </div>
        </div>

        <div class="actions">
            <h2>‚ö° Actions</h2>
            <div class="action-buttons">
                <button class="btn" id="reloadBtn">üîÑ Reload signals.json</button>
                <button class="btn" id="previewBtn" disabled>üîç Preview Changes</button>
                <button class="btn btn-warning" id="applyBtn" disabled>‚ö° Apply Updates</button>
                <button class="btn btn-success" id="downloadBtn" disabled>üíæ Download Updated File</button>
                <button class="btn" id="resetBtn">üóëÔ∏è Reset</button>
            </div>
            
            <div class="file-system-note">
                <strong>üìù Note:</strong> Due to browser security restrictions, this application cannot directly modify files on your system. 
                After downloading the updated signals.json, manually replace the original file in your project folder.
            </div>
        </div>
    </div>

    <script>
        class SignalsUpdater {
            constructor() {
                this.originalSignals = null;
                this.currentSignals = null;
                this.updateData = null;
                this.isApplied = false;
                this.initializeEventListeners();
                this.loadCurrentSignals();
            }

            async loadCurrentSignals() {
                try {
                    this.updateCurrentStatus('loading', 'Loading signals.json...', 'Fetching from local folder');
                    
                    const response = await fetch('./signals.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.originalSignals = JSON.parse(JSON.stringify(data)); // Deep copy for comparison
                    this.currentSignals = data;
                    this.isApplied = false;
                    
                    const meta = data.meta || {};
                    this.updateCurrentStatus('loaded', 
                        `signals.json (v${meta.v || 'unknown'})`, 
                        `Version ${meta.v || 'unknown'} | Updated: ${meta.updated || 'unknown'} | Accuracy: ${meta.accuracy || 'unknown'}`);
                    
                    this.updateStatus('currentStatus', 'Current signals.json loaded successfully', 'success');
                    this.updateButtons();
                    
                } catch (error) {
                    this.updateCurrentStatus('error', 'signals.json not found', 'Error: ' + error.message);
                    this.updateStatus('currentStatus', 
                        `Failed to load signals.json: ${error.message}. Make sure signals.json exists in the same folder as this HTML file.`, 
                        'error');
                }
            }

            updateCurrentStatus(state, title, meta) {
                const box = document.getElementById('currentSignalsBox');
                const icon = document.getElementById('currentIcon');
                const titleEl = document.getElementById('currentTitle');
                const metaEl = document.getElementById('currentMeta');
                
                // Reset classes
                box.className = `current-signals ${state}`;
                icon.className = `current-signals-icon ${state}`;
                
                // Update content based on state
                switch(state) {
                    case 'loading':
                        icon.textContent = '‚è≥';
                        break;
                    case 'loaded':
                        icon.textContent = '‚úÖ';
                        break;
                    case 'error':
                        icon.textContent = '‚ùå';
                        break;
                    case 'updated':
                        icon.textContent = 'üîÑ';
                        break;
                }
                
                titleEl.textContent = title;
                metaEl.textContent = meta;
            }

            initializeEventListeners() {
                this.setupFileUpload('updateFile', 'updateUpload', (data) => {
                    this.updateData = data;
                    this.updateStatus('updateStatus', 'Update.json loaded successfully', 'success');
                    this.updateButtons();
                    this.previewChanges(); // Auto-preview when file is loaded
                });

                document.getElementById('reloadBtn').addEventListener('click', () => this.loadCurrentSignals());
                document.getElementById('previewBtn').addEventListener('click', () => this.previewChanges());
                document.getElementById('applyBtn').addEventListener('click', () => this.applyUpdates());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadUpdated());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
            }

            setupFileUpload(inputId, uploadId, callback) {
                const input = document.getElementById(inputId);
                const upload = document.getElementById(uploadId);

                upload.addEventListener('click', () => input.click());
                upload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    upload.classList.add('dragover');
                });
                upload.addEventListener('dragleave', () => upload.classList.remove('dragover'));
                upload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    upload.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0], upload, callback);
                    }
                });

                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0], upload, callback);
                    }
                });
            }

            handleFile(file, uploadElement, callback) {
                if (!file.name.endsWith('.json')) {
                    this.updateStatus('updateStatus', 'Please select a .json file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        uploadElement.classList.add('loaded');
                        uploadElement.querySelector('.upload-text').textContent = `‚úÖ ${file.name}`;
                        uploadElement.querySelector('.upload-hint').textContent = `${(file.size / 1024).toFixed(1)} KB`;
                        callback(data);
                    } catch (error) {
                        this.updateStatus('updateStatus', 'Invalid JSON file: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }

            updateStatus(elementId, message, type) {
                const element = document.getElementById(elementId);
                element.innerHTML = `<div class="status status-${type}">${message}</div>`;
            }

            updateButtons() {
                const hasCurrentSignals = this.currentSignals !== null;
                const hasUpdateData = this.updateData !== null;
                const canDownload = hasCurrentSignals && hasUpdateData;

                document.getElementById('previewBtn').disabled = !hasUpdateData;
                document.getElementById('applyBtn').disabled = !hasUpdateData;
                document.getElementById('downloadBtn').disabled = !canDownload;
            }

            previewChanges() {
                if (!this.currentSignals || !this.updateData) return;

                const preview = document.getElementById('previewContent');
                
                // Use original signals for comparison to detect actual changes
                const baseSignals = this.isApplied ? this.originalSignals : this.currentSignals;
                const changes = this.detectChanges(baseSignals, this.updateData);
                
                let html = '<div class="preview">';
                if (changes.length === 0) {
                    html += '<div class="status status-info">No changes detected - all updates are already applied</div>';
                } else {
                    html += `<h3>Changes to Apply (${changes.length} modifications):</h3>`;
                    changes.forEach(change => {
                        html += `<div class="diff diff-${change.type}">
                            <strong>${change.path}:</strong> ${change.description}
                        </div>`;
                    });
                }
                html += '</div>';
                preview.innerHTML = html;
            }

            detectChanges(current, update) {
                const changes = [];
                
                const compareObjects = (currentObj, updateObj, path = '') => {
                    for (const key in updateObj) {
                        const currentPath = path ? `${path}.${key}` : key;
                        
                        if (!(key in currentObj)) {
                            changes.push({
                                type: 'add',
                                path: currentPath,
                                description: `Add new field: ${this.formatValue(updateObj[key])}`
                            });
                        } else if (typeof updateObj[key] === 'object' && updateObj[key] !== null && !Array.isArray(updateObj[key])) {
                            compareObjects(currentObj[key], updateObj[key], currentPath);
                        } else if (JSON.stringify(currentObj[key]) !== JSON.stringify(updateObj[key])) {
                            changes.push({
                                type: 'change',
                                path: currentPath,
                                description: `Change: ${this.formatValue(currentObj[key])} ‚Üí ${this.formatValue(updateObj[key])}`
                            });
                        }
                    }
                };

                compareObjects(current, update);
                return changes;
            }

            formatValue(value) {
                if (typeof value === 'string') return `"${value}"`;
                if (Array.isArray(value)) return `[${value.join(', ')}]`;
                if (typeof value === 'object') return '{...}';
                return String(value);
            }

            applyUpdates() {
                if (!this.currentSignals || !this.updateData) return;

                // Apply updates to current signals
                this.currentSignals = this.deepMerge(this.currentSignals, this.updateData);
                
                // Update meta information
                if (this.currentSignals.meta) {
                    this.currentSignals.meta.updated = new Date().toISOString().split('T')[0];
                    if (this.updateData.meta && this.updateData.meta.v) {
                        this.currentSignals.meta.v = this.updateData.meta.v;
                    }
                }

                this.isApplied = true;
                
                // Update the current signals display
                const meta = this.currentSignals.meta || {};
                this.updateCurrentStatus('updated', 
                    `signals.json (v${meta.v || 'unknown'}) [UPDATED]`, 
                    `Version ${meta.v || 'unknown'} | Updated: ${meta.updated || 'unknown'} | Changes Applied`);

                this.updateStatus('previewContent', 
                    `‚úÖ Updates applied in memory! New version: ${this.currentSignals.meta?.v || 'unknown'}. Download the updated file to save changes.`, 
                    'warning');
                
                // Refresh preview to show no more changes
                this.previewChanges();
            }

            deepMerge(target, source) {
                const result = { ...target };
                
                for (const key in source) {
                    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                        result[key] = this.deepMerge(result[key] || {}, source[key]);
                    } else {
                        result[key] = source[key];
                    }
                }
                
                return result;
            }

            downloadUpdated() {
                if (!this.currentSignals || !this.updateData) return;

                // Generate the updated file
                const updatedSignals = this.isApplied ? 
                    this.currentSignals : 
                    this.deepMerge(this.currentSignals, this.updateData);

                // Update meta if not already applied
                if (!this.isApplied && updatedSignals.meta) {
                    updatedSignals.meta.updated = new Date().toISOString().split('T')[0];
                    if (this.updateData.meta && this.updateData.meta.v) {
                        updatedSignals.meta.v = this.updateData.meta.v;
                    }
                }

                const dataStr = JSON.stringify(updatedSignals, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'signals.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.updateStatus('previewContent', 
                    'üíæ Updated signals.json downloaded successfully! Replace the original file in your project folder to apply changes.', 
                    'success');
            }

            reset() {
                this.updateData = null;
                this.isApplied = false;
                
                // Reset current signals to original
                if (this.originalSignals) {
                    this.currentSignals = JSON.parse(JSON.stringify(this.originalSignals));
                    const meta = this.currentSignals.meta || {};
                    this.updateCurrentStatus('loaded', 
                        `signals.json (v${meta.v || 'unknown'})`, 
                        `Version ${meta.v || 'unknown'} | Updated: ${meta.updated || 'unknown'} | Accuracy: ${meta.accuracy || 'unknown'}`);
                }
                
                // Reset file input
                document.getElementById('updateFile').value = '';
                
                // Reset upload area
                const upload = document.getElementById('updateUpload');
                upload.classList.remove('loaded');
                upload.querySelector('.upload-text').textContent = 'Drop your update.json here';
                upload.querySelector('.upload-hint').textContent = 'or click to browse';
                
                // Clear status messages
                document.getElementById('updateStatus').innerHTML = '';
                document.getElementById('previewContent').innerHTML = 
                    '<div class="status status-info">Load an update.json file to see a preview of changes</div>';
                
                this.updateButtons();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new SignalsUpdater();
        });
    </script>
</body>
</html>